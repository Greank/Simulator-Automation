<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>SD é‹¼å½ˆ Gä¸–ä»£ æ°¸æ† (å°æœ&åœ‹éš›æœè‡ªé¸)</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        h1 { margin-bottom: 20px; }
        table { width: 100%; }
        @media (max-width: 768px) {
            table, thead, tbody, th, td, tr { display: block; }
            td { border: none; border-bottom: 1px solid #eee; padding: 8px; }
        }
        .char-item {
            text-align: center;
            width: 90px;
        }
        .char-label {
        font-size: 16px;      /* âœ… æ”¾å¤§å­—é«” */
        font-weight: bold;    /* âœ… åŠ ç²—æ›´æ¸…æ¥š */
        color: #222;
        margin-top: 6px;
        }
        .char-label input {
        width: 48px;
        font-size: 16px;       /* âœ… æ”¾å¤§æ•¸å­—è¼¸å…¥æ¡†çš„å­—é«” */
        text-align: center;
        padding: 2px;
        }
        .char-item.selected img {
        border: 2px solid #f00;
        }
        .char-item.selected {
        background-color: #ffecec;
        box-shadow: 0 0 5px rgba(255, 0, 0, 0.4);
        }
        /* 1. è¡¨æ ¼æ¬„ä½çµ±ä¸€ç½®ä¸­ */
        #record-table th,
        #record-table td {
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
        }

        /* 2. åªæ”¾åœ–ç¤ºé‚£æ¬„å…è¨±å¯¬ä¸€é» */
        #record-table td:nth-child(åœ–ç¤ºåˆ†å¸ƒé‚£ä¸€æ¬„ä½ç½®) {
        white-space: normal;
        max-width: 400px;
        }

        /* 3. å…¶é¤˜æ¬„ä½ç›¡é‡å£“çª„ */
        #record-table th,
        #record-table td {
        padding: 4px 8px;
        font-size: 14px;
        min-width: 40px;
        }
    </style>
</head>
<body>
    
    <h1>SD é‹¼å½ˆ Gä¸–ä»£ æ°¸æ† (å°æœ&åœ‹éš›æœè‡ªé¸)</h1>
    
    <script>
        function searchFilter() {
            const name = document.getElementById("ur-name").value;
            const count = parseInt(document.getElementById("ur-count").value);

            fetch("/api/filter", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ [name]: count })
            })
            .then(res => res.json())
            .then(data => {
                const table = $('#record-table').DataTable();
                table.clear().rows.add(data).draw();
            });
        }
    </script>

    <h3>ğŸ” é¸æ“‡è§’è‰²é€²è¡Œæœå°‹</h3>
    <div class="character-search" style="display: flex; flex-wrap: wrap; gap: 10px;">
    <!-- æ¯å€‹è§’è‰²ä¸€å€‹ item -->
    <div class="char-item" data-name="èƒ½å¤©ä½¿">
        <img src="/images/èƒ½å¤©ä½¿.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">èƒ½å¤©ä½¿</div>
    </div>

    <div class="char-item" data-name="æµ·ç›œ">
        <img src="/images/æµ·ç›œ.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">æµ·ç›œ</div>
    </div>

    <div class="char-item" data-name="æ²™è–©æ¯”">
        <img src="/images/æ²™è–©æ¯”.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">æ²™è–©æ¯”</div>
    </div>

    <div class="char-item" data-name="è‡ªç”±">
        <img src="/images/è‡ªç”±.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">è‡ªç”±</div>
    </div>

    <div class="char-item" data-name="å‰å§†">
        <img src="/images/å‰å§†.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">å‰å§†</div>
    </div>

    <div class="char-item" data-name="çµé­”">
        <img src="/images/çµé­”.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">çµé­”</div>
    </div>

    <div class="char-item" data-name="å¤©éµ">
        <img src="/images/å¤©éµ.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">å¤©éµ</div>
    </div>

    <div class="char-item" data-name="é¢¨é›¶">
        <img src="/images/é¢¨é›¶.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">é¢¨é›¶</div>
    </div>

    <div class="char-item" data-name="é‹¼å½ˆEz8">
        <img src="/images/é‹¼å½ˆEz8.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">é‹¼å½ˆEz8</div>
    </div>

    <div class="char-item" data-name="ç¨è§’ç¸">
        <img src="/images/ç¨è§’ç¸.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">ç¨è§’ç¸</div>
    </div>

    <div class="char-item" data-name="åˆé‹¼">
        <img src="/images/åˆé‹¼.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">åˆé‹¼</div>
    </div>

    <div class="char-item" data-name="NTé‹¼å½ˆ">
        <img src="/images/NTé‹¼å½ˆ.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">NTé‹¼å½ˆ</div>
    </div>

    <div class="char-item" data-name="vé‹¼">
        <img src="/images/vé‹¼.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">vé‹¼</div>
    </div>

    <div class="char-item" data-name="é³³å‡°">
        <img src="/images/é³³å‡°.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">é³³å‡°</div>
    </div>

    <div class="char-item" data-name="æ¯”æŸ¥â€§å¥§é›·æ ¼&æ–°é˜¿ä¼½é¦¬è™Ÿ">
        <img src="/images/æ¯”æŸ¥â€§å¥§é›·æ ¼&æ–°é˜¿ä¼½é¦¬è™Ÿ.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">æ¯”æŸ¥â€§å¥§é›·æ ¼&æ–°é˜¿ä¼½é¦¬è™Ÿ</div>
    </div>
    
    <div class="char-item" data-name="å¤è»è‰äºâ€§è—é‚£â€§ä¼¯æ©æ–¯å¦&æ¼ç«">
        <img src="/images/å¤è»è‰äºâ€§è—é‚£â€§ä¼¯æ©æ–¯å¦&æ¼ç«.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">å¤è»è‰äºâ€§è—é‚£â€§ä¼¯æ©æ–¯å¦&æ¼ç«</div>
    </div>

    <div class="char-item" data-name="å¸ƒèŠå¾·â€§è«¾äº&ç™½è‰²åŸºåœ°">
        <img src="/images/å¸ƒèŠå¾·â€§è«¾äº&ç™½è‰²åŸºåœ°.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">å¸ƒèŠå¾·â€§è«¾äº&ç™½è‰²åŸºåœ°</div>
    </div>

    <div class="char-item" data-name="ç±³å¥§è‰å¥ˆâ€§å€«å¸ƒè˜­&å­¸åœ’è‰¦">
        <img src="/images/ç±³å¥§è‰å¥ˆâ€§å€«å¸ƒè˜­&å­¸åœ’è‰¦.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">ç±³å¥§è‰å¥ˆâ€§å€«å¸ƒè˜­&å­¸åœ’è‰¦</div>
    </div>

    <div class="char-item" data-name="èŠ™å‹â€§å¯¶&ç™½è‰²åŸºåœ°">
        <img src="/images/èŠ™å‹â€§å¯¶&ç™½è‰²åŸºåœ°.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">èŠ™å‹â€§å¯¶&ç™½è‰²åŸºåœ°</div>
    </div>

    <div class="char-item" data-name="æ·±æ‘ç²&è‹å‹é‹è¼¸è‰‡">
        <img src="/images/æ·±æ‘ç²&è‹å‹é‹è¼¸è‰‡.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">æ·±æ‘ç²&è‹å‹é‹è¼¸è‰‡</div>
    </div>

    <div class="char-item" data-name="è‰è‰å¨œâ€§å¤šè‰å®‰&çš®æ–¯ç¾éº—æ˜‚">
        <img src="/images/è‰è‰å¨œâ€§å¤šè‰å®‰&çš®æ–¯ç¾éº—æ˜‚.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">è‰è‰å¨œâ€§å¤šè‰å®‰&çš®æ–¯ç¾éº—æ˜‚</div>
    </div>

    <div class="char-item" data-name="å¥§çˆ¾åŠ â€§ä¼ŠèŒ²å¡&æ¼ç«">
        <img src="/images/å¥§çˆ¾åŠ â€§ä¼ŠèŒ²å¡&æ¼ç«.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">å¥§çˆ¾åŠ â€§ä¼ŠèŒ²å¡&æ¼ç«</div>
    </div>

    <div class="char-item" data-name="è’‚æ³•â€§å®‰è¿ªçˆ¾&è‡ªç”±è™Ÿ">
        <img src="/images/è’‚æ³•â€§å®‰è¿ªçˆ¾&è‡ªç”±è™Ÿ.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">è’‚æ³•â€§å®‰è¿ªçˆ¾&è‡ªç”±è™Ÿ</div>
    </div>

    <div class="char-item" data-name="æ¼¢è‚¯â€§è²å…‹ç´&æ‹‰è¿ªä¿®">
        <img src="/images/æ¼¢è‚¯â€§è²å…‹ç´&æ‹‰è¿ªä¿®.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">æ¼¢è‚¯â€§è²å…‹ç´&æ‹‰è¿ªä¿®</div>
    </div>

    <div class="char-item" data-name="ç‘ªç‰â€§æ‹‰ç±³äºæ–¯&å¤§å¤©ä½¿è™Ÿ">
        <img src="/images/ç‘ªç‰â€§æ‹‰ç±³äºæ–¯&å¤§å¤©ä½¿è™Ÿ.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">ç‘ªç‰â€§æ‹‰ç±³äºæ–¯&å¤§å¤©ä½¿è™Ÿ</div>
    </div>

    <div class="char-item" data-name="ç‘ªéº—å¨œâ€§ä¼Šå£«éº¥&æ‰˜å‹’å¯†è™Ÿ2å‹">
        <img src="/images/ç‘ªéº—å¨œâ€§ä¼Šå£«éº¥&æ‰˜å‹’å¯†è™Ÿ2å‹.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">ç‘ªéº—å¨œâ€§ä¼Šå£«éº¥&æ‰˜å‹’å¯†è™Ÿ2å‹</div>
    </div>

    <div class="char-item" data-name="çš‡â€§æâ€§è«¾ç‘åŠ &æ‰˜å‹’å¯†è™Ÿ">
        <img src="/images/çš‡â€§æâ€§è«¾ç‘åŠ &æ‰˜å‹’å¯†è™Ÿ.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">çš‡â€§æâ€§è«¾ç‘åŠ &æ‰˜å‹’å¯†è™Ÿ</div>
    </div>

    <div class="char-item" data-name="å®‰å¾·é­¯â€§å·´çˆ¾ç‰¹è²çˆ¾å¾·&æ°¸æ†è™Ÿ">
        <img src="/images/å®‰å¾·é­¯â€§å·´çˆ¾ç‰¹è²çˆ¾å¾·&æ°¸æ†è™Ÿ.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">å®‰å¾·é­¯â€§å·´çˆ¾ç‰¹è²çˆ¾å¾·&æ°¸æ†è™Ÿ</div>
    </div>

    <div class="char-item" data-name="èŠ±åœ’éº—&é˜¿ä¼½é¦¬">
        <img src="/images/èŠ±åœ’éº—&é˜¿ä¼½é¦¬.png" width="64" height="64" onclick="enableInput(this)">
        <div class="char-label">èŠ±åœ’éº—&é˜¿ä¼½é¦¬</div>
    </div>
    

    <!-- å…¶ä»–è§’è‰²å†è¤‡è£½é€™å€‹ div çµæ§‹ -->
    </div>
    <!-- ğŸŒŸ ç¾åŒ–æœå°‹æŒ‰éˆ•å€ -->
    <div style="text-align: center; margin-top: 20px;">
        <button 
            onclick="submitCharacterFilter()" 
            style="
                background-color: #4CAF50;
                color: white;
                font-size: 18px;
                padding: 10px 24px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: background-color 0.3s ease;"
            onmouseover="this.style.backgroundColor='#45a049'"
            onmouseout="this.style.backgroundColor='#4CAF50'"
        >
            ğŸ” æœå°‹
        </button>
    </div>
    

    <table id="record-table" class="display">
        <thead>
            <tr>
              <th>ID</th>
              <th>UR ç¸½æ•¸</th>
              <th>è§’è‰²</th>  <!-- âœ… æ–°å¢åœ–ç¤ºæ¬„ -->
              <th>ğŸ’°ç¸½é‡‘é¡(å°å¹£)</th> <!-- âœ… é€™æ˜¯æ–°å¢çš„æ¬„ä½ -->
            </tr>
          </thead>
          
        <tbody></tbody>
    </table>

    


    <script>
        fetch("/api/records")
            .then(res => res.json())
            .then(data => {
                const table = $('#record-table').DataTable({
                    data: data,
                    columns: [
                        { data: 'id' },
                        { data: 'total_count' },
                        {
                            data: 'ur_counts',
                            render: function (counts) {
                                if (!Array.isArray(counts)) return '';

                                return counts
                                .filter(c => c.count > 0)
                                .map(c => {
                                    const url = `/images/${c.name}.png`;
                                    const imgs = Array(c.count).fill(`<img src="${url}" title="${c.name}" >`).join("");
                                    return `
                                    <div style="display:inline-block; text-align:center; margin:5px;">
                                        ${imgs}
                                        <div style="font-size:12px; color:#444;">${c.name}</div>
                                    </div>
                                    `;
                                })
                                .join("");
                            }
                        },
                        {
                            data: 'ur_counts',
                            render: function (counts) {
                                const priceMap = {
                                    "èƒ½å¤©ä½¿": 50,
                                    "æµ·ç›œ": 30,
                                    "æ²™è–©æ¯”": 30,
                                    "å‰å§†": 10,
                                    "çµé­”": 5,
                                    "å¤©éµ": 10,
                                    "é¢¨é›¶": 20,
                                    "é‹¼å½ˆEz8": 10,
                                    "åˆé‹¼": 5,
                                    "NTé‹¼å½ˆ": 5,
                                    "vé‹¼": 10,
                                    "é³³å‡°": 20,
                                    "è‡ªç”±": 20,
                                    "ç¨è§’ç¸": 20,
                                    "æ¯”æŸ¥â€§å¥§é›·æ ¼&æ–°é˜¿ä¼½é¦¬è™Ÿ": 20,
                                    "å¤è»è‰äºâ€§è—é‚£â€§ä¼¯æ©æ–¯å¦&æ¼ç«": 20,
                                    "å¸ƒèŠå¾·â€§è«¾äº&ç™½è‰²åŸºåœ°": 20,
                                    "ç±³å¥§è‰å¥ˆâ€§å€«å¸ƒè˜­&å­¸åœ’è‰¦": 20,
                                    "èŠ™å‹â€§å¯¶&ç™½è‰²åŸºåœ°": 20,
                                    "æ·±æ‘ç²&è‹å‹é‹è¼¸è‰‡": 20,
                                    "è‰è‰å¨œâ€§å¤šè‰å®‰&çš®æ–¯ç¾éº—æ˜‚": 20,
                                    "å¥§çˆ¾åŠ â€§ä¼ŠèŒ²å¡&æ¼ç«": 20,
                                    "è’‚æ³•â€§å®‰è¿ªçˆ¾&è‡ªç”±è™Ÿ": 20,
                                    "æ¼¢è‚¯â€§è²å…‹ç´&æ‹‰è¿ªä¿®": 20,
                                    "ç‘ªç‰â€§æ‹‰ç±³äºæ–¯&å¤§å¤©ä½¿è™Ÿ": 20,
                                    "ç‘ªéº—å¨œâ€§ä¼Šå£«éº¥&æ‰˜å‹’å¯†è™Ÿ2å‹": 20,
                                    "çš‡â€§æâ€§è«¾ç‘åŠ &æ‰˜å‹’å¯†è™Ÿ": 20,
                                    "å®‰å¾·é­¯â€§å·´çˆ¾ç‰¹è²çˆ¾å¾·&æ°¸æ†è™Ÿ": 20,
                                    "èŠ±åœ’éº—&é˜¿ä¼½é¦¬": 20,
                                };

                                let total = 0;
                                let roleTypes = 0;

                                counts.forEach(c => {
                                    if (priceMap[c.name]) {
                                        total += priceMap[c.name] * c.count;
                                    }
                                });

                                // âœ… è¨ˆç®—æœ‰å¹¾ç¨®è§’è‰²æœ‰å‡ºç¾
                                const typesUsed = counts
                                    .filter(c => priceMap[c.name] && c.count > 0)
                                    .map(c => c.name);

                                const uniqueTypes = [...new Set(typesUsed)];
                                roleTypes = uniqueTypes.length;

                                if (roleTypes > 0) {
                                    const multiplier = 1 + 0.2 * roleTypes;
                                    let result = total * multiplier;
                                    result = Math.floor(result / 10) * 10;
                                    return `${result} å…ƒ`;
                                } else {
                                    return "0 å…ƒ";
                                }
                            }
                        },
                    ],
                    language: {
                        search: "æœå°‹ï¼š",
                        lengthMenu: "æ¯é é¡¯ç¤º _MENU_ ç­†",
                        zeroRecords: "æ‰¾ä¸åˆ°è³‡æ–™",
                        info: "ç¬¬ _START_ åˆ° _END_ ç­†ï¼Œå…± _TOTAL_ ç­†",
                        infoEmpty: "æ²’æœ‰è³‡æ–™",
                        paginate: {
                            first: "ç¬¬ä¸€é ",
                            last: "æœ€å¾Œä¸€é ",
                            next: "ä¸‹ä¸€é ",
                            previous: "ä¸Šä¸€é "
                        }
                    }
                });
            });
    </script>
    
    <script>
        function submitCharacterFilter() {
          const result = {};
          document.querySelectorAll(".character-list li").forEach(li => {
            const count = parseInt(li.querySelector("input").value);
            const name = li.getAttribute("data-name");
            if (count > 0) {
              result[name] = count;
            }
          });
      
          fetch("/api/filter", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(result)
          })
          .then(res => res.json())
          .then(data => {
            const table = $('#record-table').DataTable();
            table.clear().rows.add(data).draw();
          });
        }
      </script>

    <script>
        // é»åœ–ç‰‡å¾Œè®Šæˆæ•¸é‡è¼¸å…¥æ¡†
        function enableInput(img) {
        const parent = img.parentElement;
        const label = parent.querySelector('.char-label');
        const name = parent.dataset.name;

        const input = label.querySelector('input');

        // âœ… å¦‚æœå·²ç¶“æ˜¯è¼¸å…¥æ¡† â†’ å–æ¶ˆé¸æ“‡ï¼ˆé‚„åŸï¼‰
        if (input) {
            parent.classList.remove("selected");  // æ‹¿æ‰ç´…æ¡†
            label.innerHTML = name;               // é‚„åŸæˆæ–‡å­—
            return;
        }

        // âœ… å¦å‰‡ â†’ é¸æ“‡è§’è‰²ï¼ˆè½‰ç‚ºè¼¸å…¥æ¡†ï¼‰
        const inputBox = document.createElement('input');
        inputBox.type = "number";
        inputBox.min = 1;
        inputBox.value = 1;

        parent.classList.add("selected");      // åŠ ä¸Šç´…æ¡†
        label.innerHTML = '';
        label.appendChild(inputBox);
        inputBox.focus();
        }

    
        // é»æœå°‹æŒ‰éˆ•ï¼šæ”¶é›†æ‰€æœ‰è¼¸å…¥å€¼ä¸¦é€å‡º
        function submitCharacterFilter() {
        const filters = {};
        document.querySelectorAll('.char-item').forEach(item => {
            const input = item.querySelector('input');
            if (input) {
            const count = parseInt(input.value);
            const name = item.dataset.name;
            if (count > 0) {
                filters[name] = count;
            }
            }
        });
    
        console.log("é€å‡ºæ¢ä»¶ï¼š", filters);
    
        fetch("/api/filter", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(filters)
        })
        .then(res => res.json())
        .then(data => {
            const table = $('#record-table').DataTable();
            table.clear().rows.add(data).draw();
        })
        .catch(err => console.error("âŒ æœå°‹å¤±æ•—", err));
        }
    </script>
      


</body>
</html>
