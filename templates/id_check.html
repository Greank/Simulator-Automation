<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å¸³è™ŸæŸ¥é©—å·¥å…·</title>
  <style>
    body {
      font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
      text-align: center;
      padding: 20px;
    }
    #loading {
      font-size: 18px;
      color: #555;
      margin-top: 20px;
      display: none;
    }
    #result-imgs img {
      width: 300px;
      margin: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    input[type="text"] {
      padding: 6px;
      font-size: 16px;
      width: 200px;
    }
    button {
      padding: 6px 16px;
      font-size: 16px;
      margin-left: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>ğŸ†” å¸³è™Ÿåœ–ç‰‡æŸ¥é©—</h2>

  <div>
    <input type="text" id="user-id-input" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ ID">
    <button onclick="startSearch()">æœå°‹</button>
  </div>

  <div id="loading">â³ è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>

  <div id="result-imgs" style="display:none;">
    <h3>ğŸ¯ æŸ¥è©¢çµæœï¼š</h3>
    <img id="img1" src="" alt="åœ–ç‰‡1">
    <img id="img2" src="" alt="åœ–ç‰‡2">
  </div>

  <div id="submit-section" style="display:none; margin-top: 20px;">
    <h3>ğŸ“¤ è¼¸å…¥å¸³è™Ÿå¯†ç¢¼ä»¥æäº¤è³‡æ–™</h3>
    <input type="text" id="account" placeholder="å¸³è™Ÿ">
    <input type="text" id="password" placeholder="å¯†ç¢¼">
    <button onclick="submitFinal()">æäº¤</button>
    <div id="submit-result" style="margin-top:10px;"></div>
  </div>

  <div id="live-log" style="white-space: pre-line; font-family: monospace; margin-top: 20px;"></div>


  <script>
    function startSearch() {
      const userId = document.getElementById("user-id-input").value.trim();
      if (!userId) {
        alert("è«‹è¼¸å…¥å¸³è™Ÿ ID");
        return;
      }

      document.getElementById("loading").style.display = "block";
      document.getElementById("result-imgs").style.display = "none";

      fetch("/api/run_search", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert("âŒ " + data.error);
          document.getElementById("loading").style.display = "none";
          return;
        }

        // é¡¯ç¤ºåœ–ç‰‡
        document.getElementById("img1").src = data.img1 + "?t=" + Date.now();
        document.getElementById("img2").src = data.img2 + "?t=" + Date.now();
        document.getElementById("loading").style.display = "none";
        document.getElementById("result-imgs").style.display = "block";

        // âœ… é¡¯ç¤ºæäº¤å€å¡Šï¼ˆå¸³è™Ÿ/å¯†ç¢¼ï¼‰
        document.getElementById("submit-section").style.display = "block";
      })
      
      .catch(err => {
        alert("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err);
        document.getElementById("loading").style.display = "none";
      });
    }
    function submitFinal() {
        const account = document.getElementById("account").value.trim();
        const password = document.getElementById("password").value.trim();

        if (!account || !password) {
            alert("è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼");
            return;
        }

        // é¡¯ç¤º loading
        document.getElementById("loading").style.display = "block";
        document.getElementById("submit-section").style.display = "none";
        document.getElementById("live-log").innerText = "ğŸ”„ æäº¤ä¸­...\n";

        // âœ… ä¿®æ­£é‡é»ï¼šå°å¸³è™Ÿå¯†ç¢¼é€²è¡Œ URL ç·¨ç¢¼ï¼Œé¿å…ç‰¹æ®Šå­—å…ƒå¤±æ•ˆ
        const encodedAccount = encodeURIComponent(account);
        const encodedPassword = encodeURIComponent(password);
        const url = `/api/submit_stream?account=${encodedAccount}&password=${encodedPassword}`;

        const eventSource = new EventSource(url);

        eventSource.onmessage = function(event) {
            document.getElementById("live-log").innerText += event.data + "\n";

            if (event.data.includes("âœ… åŸ·è¡Œå®Œæˆ")) {
            document.getElementById("loading").style.display = "none";
            eventSource.close();

            // é¡¯ç¤º img3
            const img3 = document.createElement("img");
            img3.src = "/images/img3.png?t=" + Date.now();
            img3.style.marginTop = "20px";
            img3.style.border = "1px solid #ccc";
            img3.style.borderRadius = "8px";
            img3.style.width = "300px";
            document.getElementById("live-log").appendChild(img3);
            }
        };

        eventSource.onerror = function() {
            eventSource.close();
            document.getElementById("loading").style.display = "none";
            document.getElementById("live-log").innerText += "âŒ é€£ç·šä¸­æ–·\n";
        };
        }


  </script>
</body>
</html>
